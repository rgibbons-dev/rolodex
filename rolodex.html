<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rolodex</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Fraunces:opsz,wght@9..144,300;9..144,500;9..144,700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
--stone-50: #fafaf9;
--stone-100: #f5f5f4;
--stone-200: #e7e5e4;
--stone-300: #d6d3d1;
--stone-400: #a8a29e;
--stone-500: #78716c;
--stone-600: #57534e;
--stone-700: #44403c;
--stone-800: #292524;
--stone-900: #1c1917;
--stone-950: #0c0a09;
--amber-50: #fffbeb;
--amber-100: #fef3c7;
--amber-200: #fde68a;
--amber-400: #fbbf24;
--amber-500: #f59e0b;
--amber-600: #d97706;
--teal-50: #f0fdfa;
--teal-100: #ccfbf1;
--teal-400: #2dd4bf;
--teal-500: #14b8a6;
--teal-600: #0d9488;
--teal-700: #0f766e;
--rose-50: #fff1f2;
--rose-400: #fb7185;
--rose-500: #f43f5e;
--blue-50: #eff6ff;
--blue-400: #60a5fa;
--blue-500: #3b82f6;
--violet-50: #f5f3ff;
--violet-400: #a78bfa;
--violet-500: #8b5cf6;
--green-400: #4ade80;
--green-500: #22c55e;
--green-600: #16a34a;
--radius: 16px;
--radius-sm: 10px;
--radius-full: 9999px;
--shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
--shadow-md: 0 4px 12px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
--shadow-lg: 0 12px 32px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.04);
--shadow-xl: 0 20px 50px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.06);
}

html { font-size: 16px; }
body {
font-family: 'DM Sans', sans-serif;
background: var(--stone-100);
color: var(--stone-800);
min-height: 100dvh;
-webkit-font-smoothing: antialiased;
}

/* === SHELL === */
.app-shell { max-width: 460px; margin: 0 auto; min-height: 100dvh; background: var(--stone-50); position: relative; overflow-x: hidden; }

/* === VIEWS === */
.view { position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden; background: var(--stone-50); padding-bottom: 88px; }
.view::-webkit-scrollbar { width: 0; }

/* === TOP BAR === */
.top-bar { position: sticky; top: 0; z-index: 20; padding: 16px 20px 12px; background: rgba(250,250,249,0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid var(--stone-200); }
.top-bar h1 { font-family: 'Fraunces', serif; font-weight: 700; font-size: 1.65rem; letter-spacing: -0.02em; color: var(--stone-900); }
.top-bar-row { display: flex; align-items: center; justify-content: space-between; }
.top-bar .subtitle { font-size: 0.82rem; color: var(--stone-400); font-weight: 400; margin-top: 2px; }

/* === SEARCH === */
.search-wrap { margin: 12px 20px 0; position: relative; }
.search-wrap svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--stone-400); }
.search-input { width: 100%; padding: 11px 14px 11px 42px; border: 1.5px solid var(--stone-200); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.9rem; background: var(--stone-100); color: var(--stone-800); outline: none; transition: border-color 0.2s, box-shadow 0.2s, background 0.2s; }
.search-input::placeholder { color: var(--stone-400); }
.search-input:focus { border-color: var(--teal-500); box-shadow: 0 0 0 3px rgba(20,184,166,0.12); background: #fff; }

/* === SECTION LABELS === */
.section-label { padding: 20px 20px 8px; font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--stone-400); }

/* === PERSON ROW === */
.person-row { display: flex; align-items: center; gap: 14px; padding: 10px 20px; cursor: pointer; transition: background 0.15s; position: relative; }
.person-row:hover { background: var(--stone-100); }
.person-row:active { background: var(--stone-200); }

.avatar { width: 48px; height: 48px; border-radius: var(--radius-full); object-fit: cover; flex-shrink: 0; background: var(--stone-200); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; color: var(--stone-500); overflow: hidden; position: relative; }
.avatar img { width: 100%; height: 100%; object-fit: cover; }
.avatar.sm { width: 36px; height: 36px; font-size: 0.8rem; }
.avatar.lg { width: 96px; height: 96px; font-size: 2rem; }
.avatar.xl { width: 112px; height: 112px; font-size: 2.4rem; }

.person-info { flex: 1; min-width: 0; }
.person-name { font-weight: 600; font-size: 0.95rem; color: var(--stone-900); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.person-handle { font-size: 0.8rem; color: var(--stone-400); font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.person-mutual { font-size: 0.75rem; color: var(--teal-600); font-weight: 500; margin-top: 1px; }
.chevron-right { color: var(--stone-300); flex-shrink: 0; }

/* === BOTTOM NAV === */
.bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); max-width: 460px; width: 100%; display: flex; background: rgba(250,250,249,0.92); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-top: 1px solid var(--stone-200); z-index: 50; padding-bottom: env(safe-area-inset-bottom, 0); }
.nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 10px 0 8px; background: none; border: none; font-family: inherit; font-size: 0.68rem; font-weight: 500; color: var(--stone-400); cursor: pointer; transition: color 0.15s; -webkit-tap-highlight-color: transparent; position: relative; }
.nav-btn svg { transition: color 0.15s; }
.nav-btn.active { color: var(--teal-600); }
.nav-btn.active svg { color: var(--teal-600); }
.notif-dot { position: absolute; top: 6px; right: calc(50% - 16px); width: 8px; height: 8px; border-radius: 50%; background: var(--rose-500); border: 2px solid var(--stone-50); }

/* === PROFILE VIEW === */
.profile-header { display: flex; flex-direction: column; align-items: center; padding: 40px 20px 24px; text-align: center; }
.profile-name { font-family: 'Fraunces', serif; font-weight: 700; font-size: 1.6rem; color: var(--stone-900); margin-top: 16px; letter-spacing: -0.01em; }
.profile-handle { font-size: 0.88rem; color: var(--stone-400); margin-top: 2px; }
.profile-bio { font-size: 0.88rem; color: var(--stone-600); margin-top: 10px; line-height: 1.5; max-width: 320px; }
.profile-stats { display: flex; gap: 32px; margin-top: 18px; }
.stat { text-align: center; }
.stat-num { font-weight: 700; font-size: 1.1rem; color: var(--stone-900); }
.stat-label { font-size: 0.72rem; color: var(--stone-400); margin-top: 1px; }

/* === CONTACT LINKS === */
.contact-grid { padding: 0 20px; display: flex; flex-direction: column; gap: 6px; }
.contact-link { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: #fff; border: 1.5px solid var(--stone-200); border-radius: var(--radius-sm); cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s, transform 0.1s; text-decoration: none; color: inherit; }
.contact-link:hover { border-color: var(--stone-300); box-shadow: var(--shadow-md); transform: translateY(-1px); }
.contact-link:active { transform: scale(0.985); }
.contact-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.15rem; }
.contact-icon.phone    { background: var(--teal-50); color: var(--teal-600); }
.contact-icon.whatsapp { background: #ecfdf5; color: var(--green-600); }
.contact-icon.telegram { background: var(--blue-50); color: var(--blue-500); }
.contact-icon.email    { background: var(--amber-50); color: var(--amber-600); }
.contact-icon.snapchat { background: #fefce8; color: #eab308; }
.contact-icon.instagram{ background: var(--rose-50); color: var(--rose-500); }
.contact-icon.signal   { background: var(--blue-50); color: #3a76f0; }
.contact-icon.custom   { background: var(--violet-50); color: var(--violet-500); }
.contact-text { flex: 1; min-width: 0; }
.contact-label { font-size: 0.78rem; color: var(--stone-400); font-weight: 500; }
.contact-value { font-size: 0.92rem; color: var(--stone-800); font-weight: 500; margin-top: 1px; }

/* === ACTION BTNS === */
.profile-actions { display: flex; gap: 10px; padding: 0 20px; margin-top: 20px; }
.btn { flex: 1; padding: 12px 16px; border-radius: var(--radius-sm); font-family: inherit; font-size: 0.88rem; font-weight: 600; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 8px; border: none; -webkit-tap-highlight-color: transparent; }
.btn-primary { background: var(--teal-600); color: #fff; }
.btn-primary:hover { background: var(--teal-700); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary { background: var(--stone-100); color: var(--stone-700); border: 1.5px solid var(--stone-200); }
.btn-secondary:hover { background: var(--stone-200); }
.btn-sm { padding: 8px 14px; font-size: 0.8rem; border-radius: 8px; }
.icon-btn { width: 38px; height: 38px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; background: var(--stone-100); border: 1.5px solid var(--stone-200); cursor: pointer; transition: all 0.15s; flex-shrink: 0; -webkit-tap-highlight-color: transparent; padding: 0; }
.icon-btn:hover { background: var(--stone-200); }
.icon-btn:active { transform: scale(0.92); }
.icon-btn svg { color: var(--stone-600); }

/* === SETTINGS === */
.settings-section { padding: 0 20px; margin-top: 8px; }
.settings-group { background: #fff; border: 1.5px solid var(--stone-200); border-radius: var(--radius-sm); overflow: hidden; margin-bottom: 12px; }
.settings-row { display: flex; align-items: center; gap: 14px; padding: 14px 16px; cursor: pointer; transition: background 0.12s; border-bottom: 1px solid var(--stone-100); position: relative; }
.settings-row:last-child { border-bottom: none; }
.settings-row:hover { background: var(--stone-50); }
.settings-row:active { background: var(--stone-100); }
.settings-icon { width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; }
.settings-icon.teal   { background: var(--teal-50); color: var(--teal-600); }
.settings-icon.amber  { background: var(--amber-50); color: var(--amber-600); }
.settings-icon.rose   { background: var(--rose-50); color: var(--rose-500); }
.settings-icon.blue   { background: var(--blue-50); color: var(--blue-500); }
.settings-icon.stone  { background: var(--stone-100); color: var(--stone-600); }
.settings-icon.violet { background: var(--violet-50); color: var(--violet-500); }
.settings-text { flex: 1; min-width: 0; }
.settings-label { font-size: 0.9rem; font-weight: 500; color: var(--stone-800); }
.settings-desc { font-size: 0.76rem; color: var(--stone-400); margin-top: 1px; }

.profile-edit-card { background: #fff; border: 1.5px solid var(--stone-200); border-radius: var(--radius-sm); padding: 20px; margin: 0 20px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s; }
.profile-edit-card:hover { border-color: var(--stone-300); box-shadow: var(--shadow-md); }
.profile-edit-info { flex: 1; }
.profile-edit-name { font-weight: 600; font-size: 1rem; color: var(--stone-900); }
.profile-edit-handle { font-size: 0.82rem; color: var(--stone-400); }
.profile-edit-label { font-size: 0.72rem; color: var(--teal-600); font-weight: 500; margin-top: 4px; }

/* === BACK BTN === */
.back-btn { display: flex; align-items: center; gap: 4px; background: none; border: none; color: var(--teal-600); font-family: inherit; font-size: 0.88rem; font-weight: 500; cursor: pointer; padding: 0; -webkit-tap-highlight-color: transparent; }

/* === FRIEND BADGE === */
.friend-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.72rem; font-weight: 600; margin-top: 10px; }
.friend-badge.is-friend { background: var(--teal-100); color: var(--teal-700); }
.friend-badge.mutual    { background: var(--amber-100); color: var(--amber-600); }
.friend-badge.pending   { background: var(--stone-100); color: var(--stone-500); }

/* === QR MODAL === */
.modal-overlay { position: fixed; inset: 0; background: rgba(12,10,9,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal { background: #fff; border-radius: 20px; padding: 36px 32px; max-width: 360px; width: 100%; text-align: center; box-shadow: var(--shadow-xl); transform: scale(0.92); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.modal-overlay.open .modal { transform: scale(1); }
.modal h3 { font-family: 'Fraunces', serif; font-size: 1.25rem; font-weight: 700; color: var(--stone-900); margin-bottom: 4px; }
.modal p { font-size: 0.82rem; color: var(--stone-400); margin-bottom: 20px; }
.qr-box { width: 200px; height: 200px; margin: 0 auto 20px; background: #fff; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; border: 2px solid var(--stone-100); overflow: hidden; }
.qr-box img { width: 100%; height: 100%; object-fit: contain; }
.modal .btn { margin-top: 8px; }

/* === DISCOVER === */
.discover-cards { padding: 0 20px; display: flex; flex-direction: column; gap: 8px; }
.discover-card { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: #fff; border: 1.5px solid var(--stone-200); border-radius: var(--radius-sm); cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s; }
.discover-card:hover { border-color: var(--stone-300); box-shadow: var(--shadow-md); }

/* === TAB PILLS === */
.tab-row { display: flex; gap: 6px; padding: 12px 20px 0; }
.tab-pill { padding: 7px 16px; border-radius: var(--radius-full); font-family: inherit; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: 1.5px solid var(--stone-200); background: #fff; color: var(--stone-500); transition: all 0.15s; -webkit-tap-highlight-color: transparent; }
.tab-pill.active { background: var(--stone-800); color: #fff; border-color: var(--stone-800); }

/* === EMPTY STATE === */
.empty-state { text-align: center; padding: 48px 20px; color: var(--stone-400); }
.empty-state svg { margin: 0 auto 12px; opacity: 0.4; }
.empty-state p { font-size: 0.88rem; }

/* === TOAST === */
.toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--stone-800); color: #fff; padding: 10px 20px; border-radius: var(--radius-full); font-size: 0.82rem; font-weight: 500; box-shadow: var(--shadow-lg); opacity: 0; transition: all 0.3s; z-index: 200; pointer-events: none; white-space: nowrap; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* === AUTH === */
.auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100dvh; padding: 40px 24px; text-align: center; }
.auth-logo { font-family: 'Fraunces', serif; font-weight: 700; font-size: 2.5rem; color: var(--stone-900); letter-spacing: -0.03em; }
.auth-tagline { font-size: 0.92rem; color: var(--stone-400); margin-top: 4px; margin-bottom: 36px; }
.auth-card { background: #fff; border: 1.5px solid var(--stone-200); border-radius: var(--radius); padding: 28px 24px; width: 100%; max-width: 360px; }
.auth-card h2 { font-family: 'Fraunces', serif; font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; color: var(--stone-900); }
.form-field { margin-bottom: 14px; text-align: left; }
.form-field label { display: block; font-size: 0.78rem; font-weight: 600; color: var(--stone-500); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.05em; }
.form-field input { width: 100%; padding: 11px 14px; border: 1.5px solid var(--stone-200); border-radius: 8px; font-family: inherit; font-size: 0.9rem; color: var(--stone-800); outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
.form-field input:focus { border-color: var(--teal-500); box-shadow: 0 0 0 3px rgba(20,184,166,0.12); }
.form-error { color: var(--rose-500); font-size: 0.78rem; margin-top: 4px; }
.auth-switch { font-size: 0.82rem; color: var(--stone-400); margin-top: 20px; }
.auth-switch a { color: var(--teal-600); font-weight: 600; cursor: pointer; text-decoration: none; }
.auth-divider { display: flex; align-items: center; gap: 12px; margin: 18px 0; font-size: 0.75rem; color: var(--stone-400); }
.auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--stone-200); }
.seed-btn { margin-top: 16px; font-size: 0.78rem; color: var(--stone-400); background: none; border: 1px dashed var(--stone-300); border-radius: 8px; padding: 8px 16px; cursor: pointer; font-family: inherit; transition: all 0.15s; }
.seed-btn:hover { border-color: var(--teal-500); color: var(--teal-600); }

/* === LOADING === */
.spinner { width: 20px; height: 20px; border: 2.5px solid var(--stone-200); border-top-color: var(--teal-500); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-center { display: flex; justify-content: center; padding: 40px; }

/* === ANIMATIONS === */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.fade-in-up { animation: fadeInUp 0.35s cubic-bezier(0.4, 0, 0.2, 1) both; }
</style>
</head>
<body>

<div class="app-shell" id="app"></div>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="qr-modal">
  <div class="modal">
    <h3 id="qr-title">Share Profile</h3>
    <p id="qr-sub">Scan to add me</p>
    <div class="qr-box" id="qr-box"><div class="spinner"></div></div>
    <button class="btn btn-secondary" onclick="closeQR()" style="width:100%">Done</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API CLIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = window.location.origin;

function getTokens() {
  try { return JSON.parse(localStorage.getItem('rolodex_tokens') || 'null'); }
  catch { return null; }
}

function saveTokens(tokens) {
  localStorage.setItem('rolodex_tokens', JSON.stringify(tokens));
}

function clearTokens() {
  localStorage.removeItem('rolodex_tokens');
  localStorage.removeItem('rolodex_me');
}

async function api(path, opts = {}) {
  const tokens = getTokens();
  const headers = { ...(opts.headers || {}) };

  if (tokens?.accessToken) {
    headers['Authorization'] = `Bearer ${tokens.accessToken}`;
  }

  if (opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)) {
    headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(opts.body);
  }

  const res = await fetch(`${API}${path}`, { ...opts, headers });

  // Try refresh if 401
  if (res.status === 401 && tokens?.refreshToken) {
    const refreshRes = await fetch(`${API}/auth/refresh`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ refreshToken: tokens.refreshToken }),
    });
    if (refreshRes.ok) {
      const newTokens = await refreshRes.json();
      saveTokens(newTokens);
      headers['Authorization'] = `Bearer ${newTokens.accessToken}`;
      return fetch(`${API}${path}`, { ...opts, headers });
    } else {
      clearTokens();
      renderApp('auth');
      throw new Error('Session expired');
    }
  }

  return res;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentView = 'auth';
let viewStack = [];
let discoverTab = 'suggestions';
let ME = null; // Current user from API
let unreadNotifCount = 0;

// Caches for current render cycle
let friendsCache = null;
let pendingRequestsCache = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLORS = [
  ['#0d9488','#ccfbf1'], ['#d97706','#fef3c7'], ['#7c3aed','#ede9fe'],
  ['#db2777','#fce7f3'], ['#2563eb','#dbeafe'], ['#059669','#d1fae5'],
  ['#dc2626','#fee2e2'], ['#7c2d12','#fed7aa'], ['#4338ca','#e0e7ff'],
  ['#0369a1','#e0f2fe'],
];

function userColor(id) {
  let hash = 0;
  for (let i = 0; i < id.length; i++) hash = ((hash << 5) - hash + id.charCodeAt(i)) | 0;
  return COLORS[Math.abs(hash) % COLORS.length];
}

function initials(name) {
  return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
}

function avatarHTML(user, size='') {
  const cls = size ? `avatar ${size}` : 'avatar';
  if (user.avatarUrl) {
    return `<div class="${cls}"><img src="${user.avatarUrl}" alt="${user.displayName}"></div>`;
  }
  const [fg, bg] = userColor(user.id);
  return `<div class="${cls}" style="background:${bg};color:${fg}">${initials(user.displayName)}</div>`;
}

function chevronSVG() {
  return `<svg class="chevron-right" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M6 4l4 4-4 4"/></svg>`;
}

function searchSVG() {
  return `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="8" cy="8" r="5.5"/><path d="M12 12l4 4"/></svg>`;
}

const CONTACT_ICONS = {
  phone: 'ğŸ“', whatsapp: 'ğŸ’¬', telegram: 'âœˆï¸', email: 'âœ‰ï¸',
  signal: 'ğŸ”’', snapchat: 'ğŸ‘»', instagram: 'ğŸ“·', custom: 'ğŸ”—'
};

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAuth(mode = 'login') {
  return `
    <div class="auth-screen">
      <div class="auth-logo">Rolodex</div>
      <div class="auth-tagline">Your connection card</div>
      <div class="auth-card" id="auth-card">
        ${mode === 'register' ? `
          <h2>Create account</h2>
          <div class="form-field">
            <label>Handle</label>
            <input type="text" id="reg-handle" placeholder="jordanr" autocomplete="username">
          </div>
          <div class="form-field">
            <label>Display Name</label>
            <input type="text" id="reg-name" placeholder="Jordan Rivera">
          </div>
          <div class="form-field">
            <label>Email</label>
            <input type="email" id="reg-email" placeholder="jordan@hey.com">
          </div>
          <div id="auth-error" class="form-error"></div>
          <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="doRegister()">Sign Up</button>
          <div class="auth-switch">Already have an account? <a onclick="renderApp('auth', 'login')">Log in</a></div>
        ` : `
          <h2>Welcome back</h2>
          <div class="form-field">
            <label>Email</label>
            <input type="email" id="login-email" placeholder="jordan@hey.com">
          </div>
          <div id="auth-error" class="form-error"></div>
          <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="doLogin()">Send Magic Link</button>
          <div class="auth-divider">or</div>
          <button class="btn btn-secondary" style="width:100%" onclick="renderApp('auth', 'register')">Create Account</button>
          <div class="auth-switch">
            Have a magic link token? <a onclick="promptMagicToken()">Enter token</a>
          </div>
        `}
      </div>
      <button class="seed-btn" onclick="doSeed()">Seed demo data &amp; log in</button>
    </div>
  `;
}

async function doRegister() {
  const handle = document.getElementById('reg-handle')?.value?.trim();
  const displayName = document.getElementById('reg-name')?.value?.trim();
  const email = document.getElementById('reg-email')?.value?.trim();
  const errEl = document.getElementById('auth-error');

  if (!handle || !displayName || !email) {
    errEl.textContent = 'All fields are required';
    return;
  }

  try {
    const res = await fetch(`${API}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ handle, displayName, email }),
    });
    const data = await res.json();
    if (!res.ok) {
      errEl.textContent = data.error || 'Registration failed';
      return;
    }
    saveTokens({ accessToken: data.accessToken, refreshToken: data.refreshToken });
    await loadMe();
    renderApp('my-profile');
    showToast('Account created!');
  } catch (e) {
    errEl.textContent = 'Network error';
  }
}

async function doLogin() {
  const email = document.getElementById('login-email')?.value?.trim();
  const errEl = document.getElementById('auth-error');

  if (!email) {
    errEl.textContent = 'Email is required';
    return;
  }

  try {
    const res = await fetch(`${API}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email }),
    });
    const data = await res.json();
    if (!res.ok) {
      errEl.textContent = data.error || 'Login failed';
      return;
    }
    showToast('Magic link sent! Check console for the token.');
    errEl.textContent = '';
  } catch (e) {
    errEl.textContent = 'Network error';
  }
}

function promptMagicToken() {
  const token = prompt('Paste your magic link token:');
  if (token) verifyMagicToken(token.trim());
}

async function verifyMagicToken(token) {
  try {
    const res = await fetch(`${API}/auth/magic-link/verify?token=${encodeURIComponent(token)}`);
    const data = await res.json();
    if (!res.ok) {
      showToast(data.error || 'Invalid token');
      return;
    }
    saveTokens({ accessToken: data.accessToken, refreshToken: data.refreshToken });
    await loadMe();
    renderApp('my-profile');
    showToast('Logged in!');
  } catch (e) {
    showToast('Network error');
  }
}

async function doSeed() {
  try {
    const res = await fetch(`${API}/seed`, { method: 'POST' });
    const data = await res.json();
    if (data.accessToken) {
      saveTokens({ accessToken: data.accessToken, refreshToken: data.refreshToken });
      await loadMe();
      renderApp('my-profile');
      showToast(data.message || 'Demo data loaded!');
    } else {
      showToast(data.message || 'Seed complete');
    }
  } catch (e) {
    showToast('Seed failed â€” is the server running?');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD CURRENT USER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadMe() {
  const tokens = getTokens();
  if (!tokens) return null;

  try {
    const res = await api('/users/me/contacts');
    if (!res.ok) { clearTokens(); return null; }
    const contactData = await res.json();

    // We need to get our own profile. Decode JWT to get handle.
    const payload = JSON.parse(atob(tokens.accessToken.split('.')[1]));
    const profileRes = await api(`/users/${payload.handle}`);
    if (!profileRes.ok) { clearTokens(); return null; }
    const profile = await profileRes.json();

    ME = {
      ...profile,
      myContacts: contactData.contacts || [],
    };
    localStorage.setItem('rolodex_me', JSON.stringify(ME));

    // Load notification count
    try {
      const notifRes = await api('/users/me/notifications?limit=1');
      if (notifRes.ok) {
        const notifData = await notifRes.json();
        unreadNotifCount = notifData.unreadCount || 0;
      }
    } catch {}

    return ME;
  } catch {
    return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderContactLinks(contacts) {
  if (!contacts || contacts.length === 0) {
    return '<div class="empty-state" style="padding:20px"><p>No contact links shared</p></div>';
  }
  return contacts.map((c, i) => `
    <a class="contact-link fade-in-up" style="animation-delay:${i * 0.04}s" href="#"
       onclick="event.preventDefault(); copyContact('${escHtml(c.value)}', '${escHtml(c.label)}')">
      <div class="contact-icon ${c.type}">${CONTACT_ICONS[c.type] || 'ğŸ”—'}</div>
      <div class="contact-text">
        <div class="contact-label">${escHtml(c.label)}</div>
        <div class="contact-value">${escHtml(c.value)}</div>
      </div>
      <svg width="16" height="16" fill="none" stroke="var(--stone-300)" stroke-width="2" stroke-linecap="round">
        <rect x="3" y="5" width="7" height="9" rx="1.5"/>
        <path d="M6 5V3.5A1.5 1.5 0 0 1 7.5 2h4A1.5 1.5 0 0 1 13 3.5v6a1.5 1.5 0 0 1-1.5 1.5H10"/>
      </svg>
    </a>
  `).join('');
}

function renderPersonRow(user, extra='', onclickOverride) {
  const click = onclickOverride || `navigateTo('profile', '${user.handle}')`;
  return `
    <div class="person-row" onclick="${click}">
      ${avatarHTML(user)}
      <div class="person-info">
        <div class="person-name">${escHtml(user.displayName)}</div>
        <div class="person-handle">@${escHtml(user.handle)}</div>
        ${extra}
      </div>
      ${chevronSVG()}
    </div>
  `;
}

// â”€â”€â”€ MY PROFILE VIEW â”€â”€â”€
function renderMyProfile() {
  if (!ME) return '<div class="loading-center"><div class="spinner"></div></div>';
  const contactCount = ME.myContacts?.length || 0;
  const friendCount = ME.contactLinks?.length !== undefined ? '...' : '...';

  return `
    <div class="view" id="view-my-profile">
      <div class="top-bar">
        <div class="top-bar-row">
          <div>
            <h1>Rolodex</h1>
            <div class="subtitle">Your connection card</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="icon-btn" onclick="openQR('${ME.handle}')" title="Share QR Code">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
                <rect x="2" y="2" width="5" height="5" rx="1"/><rect x="11" y="2" width="5" height="5" rx="1"/>
                <rect x="2" y="11" width="5" height="5" rx="1"/><rect x="12" y="12" width="1.5" height="1.5"/>
                <path d="M16 11h-2v3h3v-1.5M11 16h2"/>
              </svg>
            </button>
            <button class="icon-btn" onclick="viewStack=[];renderApp('settings')" title="Settings">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
                <circle cx="9" cy="9" r="2.5"/>
                <path d="M9 1.5v2M9 14.5v2M1.5 9h2M14.5 9h2M3.7 3.7l1.4 1.4M12.9 12.9l1.4 1.4M3.7 14.3l1.4-1.4M12.9 5.1l1.4-1.4"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="profile-header fade-in-up">
        ${avatarHTML(ME, 'xl')}
        <div class="profile-name">${escHtml(ME.displayName)}</div>
        <div class="profile-handle">@${escHtml(ME.handle)}</div>
        <div class="profile-bio">${escHtml(ME.bio || '')}</div>
        <div class="profile-stats" id="my-stats">
          <div class="stat"><div class="stat-num" id="my-friend-count"><div class="spinner" style="width:14px;height:14px;border-width:2px"></div></div><div class="stat-label">Friends</div></div>
          <div class="stat"><div class="stat-num">${contactCount}</div><div class="stat-label">Links</div></div>
        </div>
      </div>
      <div class="section-label">How to reach me</div>
      <div class="contact-grid">
        ${renderContactLinks(ME.myContacts)}
      </div>
    </div>
  `;
}

// Load friend count asynchronously
async function loadFriendCount() {
  try {
    const res = await api('/users/me/friends?limit=1');
    if (res.ok) {
      const data = await res.json();
      const el = document.getElementById('my-friend-count');
      if (el) el.textContent = data.total ?? data.friends?.length ?? 0;
    }
  } catch {}
}

// â”€â”€â”€ FRIENDS VIEW â”€â”€â”€
async function renderFriendsAsync(searchTerm = '') {
  const app = document.getElementById('app');
  // Show loading first time
  if (!friendsCache) {
    try {
      const res = await api('/users/me/friends?limit=100');
      if (res.ok) friendsCache = await res.json();
    } catch {}
  }

  if (!friendsCache) return;

  let friends = friendsCache.friends || [];
  if (searchTerm) {
    const q = searchTerm.toLowerCase();
    friends = friends.filter(u =>
      u.displayName?.toLowerCase().includes(q) || u.handle?.toLowerCase().includes(q)
    );
  }

  const content = document.getElementById('friends-list');
  if (content) {
    content.innerHTML = friends.length === 0
      ? `<div class="empty-state"><p>${searchTerm ? `No friends match "${escHtml(searchTerm)}"` : 'No friends yet. Discover people!'}</p></div>`
      : `<div class="section-label">All friends (${friendsCache.total || friends.length})</div>
         ${friends.map(u => renderPersonRow(u)).join('')}`;
  }
}

function renderFriends(searchTerm = '') {
  return `
    <div class="view" id="view-friends">
      <div class="top-bar">
        <h1>Friends</h1>
        <div class="subtitle" id="friends-subtitle">Your connections</div>
        <div class="search-wrap">
          ${searchSVG()}
          <input class="search-input" type="text" placeholder="Search friends..."
            value="${escHtml(searchTerm)}" oninput="renderFriendsAsync(this.value)">
        </div>
      </div>
      <div id="friends-list"><div class="loading-center"><div class="spinner"></div></div></div>
    </div>
  `;
}

// â”€â”€â”€ DISCOVER VIEW â”€â”€â”€
function renderDiscover(searchTerm = '') {
  return `
    <div class="view" id="view-discover">
      <div class="top-bar">
        <h1>Discover</h1>
        <div class="subtitle">Find new connections</div>
        <div class="search-wrap">
          ${searchSVG()}
          <input class="search-input" type="text" placeholder="Search by name..."
            value="${escHtml(searchTerm)}" oninput="doDiscoverSearch(this.value)">
        </div>
      </div>
      <div id="discover-content"><div class="loading-center"><div class="spinner"></div></div></div>
    </div>
  `;
}

let searchTimeout = null;
function doDiscoverSearch(query) {
  clearTimeout(searchTimeout);
  if (!query || query.length < 2) {
    loadDiscoverContent();
    return;
  }
  searchTimeout = setTimeout(async () => {
    const content = document.getElementById('discover-content');
    if (!content) return;
    content.innerHTML = '<div class="loading-center"><div class="spinner"></div></div>';

    try {
      const res = await api(`/discover/search?q=${encodeURIComponent(query)}&limit=20`);
      if (!res.ok) { content.innerHTML = '<div class="empty-state"><p>Search failed</p></div>'; return; }
      const data = await res.json();

      if (!data.results || data.results.length === 0) {
        content.innerHTML = `<div class="empty-state"><p>No one found for "${escHtml(query)}"</p></div>`;
        return;
      }

      content.innerHTML = `
        <div class="section-label">${data.results.length} result${data.results.length !== 1 ? 's' : ''}</div>
        ${data.results.map(u => renderPersonRow(u)).join('')}
      `;
    } catch {
      content.innerHTML = '<div class="empty-state"><p>Search failed</p></div>';
    }
  }, 300);
}

async function loadDiscoverContent() {
  const content = document.getElementById('discover-content');
  if (!content) return;

  content.innerHTML = '<div class="loading-center"><div class="spinner"></div></div>';

  try {
    const res = await api('/discover/suggestions?limit=20');
    if (!res.ok) { content.innerHTML = '<div class="empty-state"><p>Could not load suggestions</p></div>'; return; }
    const data = await res.json();
    const suggestions = data.suggestions || [];

    if (suggestions.length === 0) {
      content.innerHTML = '<div class="empty-state"><p>No suggestions right now. Add more friends!</p></div>';
      return;
    }

    content.innerHTML = `
      <div class="section-label">People you may know</div>
      <div class="discover-cards">
        ${suggestions.map((s, i) => `
          <div class="discover-card fade-in-up" style="animation-delay:${i * 0.05}s"
               onclick="navigateTo('profile','${escHtml(s.handle)}')">
            ${avatarHTML(s)}
            <div class="person-info">
              <div class="person-name">${escHtml(s.displayName)}</div>
              <div class="person-handle">@${escHtml(s.handle)}</div>
              <div class="person-mutual">${s.mutualFriendCount} mutual${s.mutualFriendCount !== 1 ? 's' : ''}</div>
            </div>
            ${chevronSVG()}
          </div>
        `).join('')}
      </div>
    `;
  } catch {
    content.innerHTML = '<div class="empty-state"><p>Could not load suggestions</p></div>';
  }
}

// â”€â”€â”€ PROFILE DETAIL VIEW â”€â”€â”€
function renderProfile(handle) {
  return `
    <div class="view" id="view-profile">
      <div class="top-bar">
        <div class="top-bar-row">
          <button class="back-btn" onclick="goBack()">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4L5 9l6 5"/></svg>
            Back
          </button>
          <button class="icon-btn" onclick="openQR('${escHtml(handle)}')" title="Share profile">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
              <rect x="2" y="2" width="5" height="5" rx="1"/><rect x="11" y="2" width="5" height="5" rx="1"/>
              <rect x="2" y="11" width="5" height="5" rx="1"/><rect x="12" y="12" width="1.5" height="1.5"/>
              <path d="M16 11h-2v3h3v-1.5M11 16h2"/>
            </svg>
          </button>
        </div>
      </div>
      <div id="profile-content"><div class="loading-center"><div class="spinner"></div></div></div>
    </div>
  `;
}

async function loadProfileContent(handle) {
  const content = document.getElementById('profile-content');
  if (!content) return;

  try {
    const res = await api(`/users/${handle}`);
    if (!res.ok) {
      content.innerHTML = '<div class="empty-state"><p>User not found</p></div>';
      return;
    }
    const user = await res.json();
    const isMe = ME && user.id === ME.id;
    const isFriend = user.relationship === 'accepted';
    const isPending = user.relationship === 'pending';

    let friendsHtml = '';
    try {
      const fRes = await api(`/users/${handle}/friends?limit=6`);
      if (fRes.ok) {
        const fData = await fRes.json();
        if (fData.friends && fData.friends.length > 0) {
          friendsHtml = `
            <div class="section-label">Their Friends</div>
            ${fData.friends.slice(0, 6).map(f => renderPersonRow(f)).join('')}
          `;
        }
      }
    } catch {}

    let mutualsHtml = '';
    if (!isMe && user.mutualFriendCount > 0) {
      try {
        const mRes = await api(`/users/${handle}/mutuals`);
        if (mRes.ok) {
          const mData = await mRes.json();
          if (mData.mutuals && mData.mutuals.length > 0) {
            mutualsHtml = `
              <div class="section-label">Mutual Friends</div>
              ${mData.mutuals.map(m => renderPersonRow(m)).join('')}
            `;
          }
        }
      } catch {}
    }

    content.innerHTML = `
      <div class="profile-header fade-in-up">
        ${avatarHTML(user, 'xl')}
        <div class="profile-name">${escHtml(user.displayName)}</div>
        <div class="profile-handle">@${escHtml(user.handle)}</div>
        ${isFriend ? '<div class="friend-badge is-friend">âœ“ Friends</div>' :
          isPending ? '<div class="friend-badge pending">â³ Pending</div>' :
          user.mutualFriendCount > 0 ? `<div class="friend-badge mutual">${user.mutualFriendCount} mutual friend${user.mutualFriendCount > 1 ? 's' : ''}</div>` : ''}
        <div class="profile-bio">${escHtml(user.bio || '')}</div>
        <div class="profile-stats">
          <div class="stat"><div class="stat-num">${user.contactLinks?.length || 0}</div><div class="stat-label">Links</div></div>
        </div>
      </div>
      ${!isMe && !isFriend && !isPending ? `
        <div class="profile-actions">
          <button class="btn btn-primary" id="add-friend-btn" onclick="sendFriendRequest('${user.id}', this)">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M8 3v10M3 8h10"/></svg>
            Add Friend
          </button>
        </div>
      ` : ''}
      <div class="section-label" style="margin-top:8px">Contact</div>
      <div class="contact-grid">
        ${renderContactLinks(user.contactLinks)}
      </div>
      ${mutualsHtml}
      ${friendsHtml}
    `;
  } catch {
    content.innerHTML = '<div class="empty-state"><p>Failed to load profile</p></div>';
  }
}

// â”€â”€â”€ SETTINGS VIEW â”€â”€â”€
function renderSettings() {
  if (!ME) return '<div class="loading-center"><div class="spinner"></div></div>';

  return `
    <div class="view" id="view-settings">
      <div class="top-bar">
        <h1>Settings</h1>
        <div class="subtitle">Profile & preferences</div>
      </div>

      <div class="section-label">Profile</div>
      <div class="profile-edit-card" onclick="viewStack=[];renderApp('my-profile')">
        ${avatarHTML(ME, 'lg')}
        <div class="profile-edit-info">
          <div class="profile-edit-name">${escHtml(ME.displayName)}</div>
          <div class="profile-edit-handle">@${escHtml(ME.handle)}</div>
          <div class="profile-edit-label">View your card â†’</div>
        </div>
      </div>

      <div class="section-label">Account</div>
      <div class="settings-section">
        <div class="settings-group">
          <div class="settings-row" onclick="editProfile()">
            <div class="settings-icon teal">âœï¸</div>
            <div class="settings-text">
              <div class="settings-label">Edit Profile</div>
              <div class="settings-desc">Name, bio</div>
            </div>
            ${chevronSVG()}
          </div>
          <div class="settings-row" onclick="openQR('${ME.handle}')">
            <div class="settings-icon violet">ğŸ“²</div>
            <div class="settings-text">
              <div class="settings-label">My QR Code</div>
              <div class="settings-desc">Share your profile card</div>
            </div>
            ${chevronSVG()}
          </div>
        </div>
      </div>

      <div class="section-label">Notifications</div>
      <div class="settings-section">
        <div class="settings-group">
          <div class="settings-row" onclick="viewStack=[];loadNotificationsView()">
            <div class="settings-icon amber">ğŸ””</div>
            <div class="settings-text">
              <div class="settings-label">Notifications</div>
              <div class="settings-desc">${unreadNotifCount > 0 ? `${unreadNotifCount} unread` : 'All caught up'}</div>
            </div>
            ${chevronSVG()}
          </div>
        </div>
      </div>

      <div class="section-label">Data</div>
      <div class="settings-section">
        <div class="settings-group">
          <div class="settings-row" onclick="exportVcf()">
            <div class="settings-icon amber">ğŸ“¤</div>
            <div class="settings-text">
              <div class="settings-label">Export as vCard</div>
              <div class="settings-desc">Download friends as .vcf</div>
            </div>
            ${chevronSVG()}
          </div>
          <div class="settings-row" onclick="exportCsv()">
            <div class="settings-icon teal">ğŸ“‹</div>
            <div class="settings-text">
              <div class="settings-label">Export as CSV</div>
              <div class="settings-desc">Download friends as .csv</div>
            </div>
            ${chevronSVG()}
          </div>
        </div>
      </div>

      <div class="section-label">Privacy</div>
      <div class="settings-section">
        <div class="settings-group">
          <div class="settings-row" onclick="togglePrivacy()">
            <div class="settings-icon rose">ğŸ”’</div>
            <div class="settings-text">
              <div class="settings-label">Profile Visibility</div>
              <div class="settings-desc" id="privacy-desc">${ME.isPublic ? 'Public â€” anyone can see your friend list' : 'Private â€” only friends see your friend list'}</div>
            </div>
            ${chevronSVG()}
          </div>
        </div>
      </div>

      <div class="settings-section" style="margin-top:16px;margin-bottom:40px;text-align:center">
        <button class="btn btn-secondary" style="width:100%;color:var(--rose-500);border-color:var(--rose-400)" onclick="doSignOut()">
          Sign Out
        </button>
        <div style="margin-top:16px;font-size:0.72rem;color:var(--stone-400)">
          Rolodex v0.1.0 Â· Backed by a real API
        </div>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderApp(view, searchTerm = '') {
  if (view) currentView = view;
  const app = document.getElementById('app');

  // Auth check
  const tokens = getTokens();
  if (!tokens && currentView !== 'auth') {
    currentView = 'auth';
  }

  let html = '';
  switch (currentView) {
    case 'auth':       html = renderAuth(searchTerm || 'login'); break;
    case 'my-profile': html = renderMyProfile(); break;
    case 'friends':    html = renderFriends(searchTerm); break;
    case 'discover':   html = renderDiscover(searchTerm); break;
    case 'settings':   html = renderSettings(); break;
    case 'profile':    html = renderProfile(viewStack[viewStack.length - 1]); break;
    default:           html = renderMyProfile(); break;
  }

  // Bottom nav (only when logged in and not auth)
  if (currentView !== 'auth') {
    html += `
      <nav class="bottom-nav">
        <button class="nav-btn ${currentView === 'my-profile' ? 'active' : ''}" onclick="viewStack=[];renderApp('my-profile')">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
            <circle cx="11" cy="8" r="4"/><path d="M3 20c0-4.4 3.6-8 8-8s8 3.6 8 8"/>
          </svg>
          Me
        </button>
        <button class="nav-btn ${currentView === 'friends' ? 'active' : ''}" onclick="viewStack=[];friendsCache=null;renderApp('friends')">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
            <circle cx="8" cy="7" r="3.5"/><circle cx="16" cy="9" r="2.5"/>
            <path d="M1 19c0-3.9 3.1-7 7-7 1.6 0 3 .5 4.2 1.4M13 19c0-2.8 1.8-5 4-5s4 2.2 4 5"/>
          </svg>
          Friends
        </button>
        <button class="nav-btn ${currentView === 'discover' ? 'active' : ''}" onclick="viewStack=[];renderApp('discover')">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
            <circle cx="11" cy="11" r="7.5"/><path d="M16 16l4 4"/>
            <circle cx="11" cy="9" r="2.5"/><path d="M7 15c0-2.2 1.8-4 4-4s4 1.8 4 4"/>
          </svg>
          Discover
        </button>
        <button class="nav-btn ${currentView === 'settings' ? 'active' : ''}" onclick="viewStack=[];renderApp('settings')">
          ${unreadNotifCount > 0 ? '<div class="notif-dot"></div>' : ''}
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
            <circle cx="11" cy="11" r="3"/>
            <path d="M11 2v3M11 17v3M2 11h3M17 11h3M4.9 4.9l2.1 2.1M15 15l2.1 2.1M4.9 17.1l2.1-2.1M15 7l2.1-2.1"/>
          </svg>
          Settings
        </button>
      </nav>
    `;
  }

  app.innerHTML = html;

  // Post-render hooks
  if (currentView === 'my-profile') loadFriendCount();
  if (currentView === 'friends') renderFriendsAsync(searchTerm);
  if (currentView === 'discover') loadDiscoverContent();
  if (currentView === 'profile') loadProfileContent(viewStack[viewStack.length - 1]);

  // Restore search focus
  if (searchTerm && currentView !== 'auth') {
    const input = app.querySelector('.search-input');
    if (input) { input.focus(); input.setSelectionRange(input.value.length, input.value.length); }
  }
}

function navigateTo(view, handle) {
  if (handle) viewStack.push(handle);
  renderApp(view);
}

function goBack() {
  viewStack.pop();
  if (viewStack.length > 0) {
    renderApp('profile');
  } else {
    renderApp('friends');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyContact(value, label) {
  navigator.clipboard?.writeText(value);
  showToast(`Copied ${label}: ${value}`);
}

async function sendFriendRequest(userId, btn) {
  if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px"></div> Sending...'; }
  try {
    const res = await api(`/friends/request/${userId}`, { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      showToast('Friend request sent!');
      if (btn) btn.innerHTML = 'â³ Pending';
      friendsCache = null; // Invalidate
    } else {
      showToast(data.error || 'Failed to send request');
      if (btn) { btn.disabled = false; btn.innerHTML = 'Add Friend'; }
    }
  } catch {
    showToast('Network error');
    if (btn) { btn.disabled = false; btn.innerHTML = 'Add Friend'; }
  }
}

async function openQR(handle) {
  document.getElementById('qr-title').textContent = 'Share Profile';
  document.getElementById('qr-sub').textContent = `Scan to connect with @${handle}`;
  document.getElementById('qr-box').innerHTML = '<div class="spinner"></div>';
  document.getElementById('qr-modal').classList.add('open');

  try {
    const res = await api(`/qr/${handle}/data-url`);
    if (res.ok) {
      const data = await res.json();
      document.getElementById('qr-box').innerHTML = `<img src="${data.dataUrl}" alt="QR Code for @${handle}">`;
    } else {
      document.getElementById('qr-box').innerHTML = '<p style="color:var(--stone-400);font-size:0.82rem">QR generation failed</p>';
    }
  } catch {
    document.getElementById('qr-box').innerHTML = '<p style="color:var(--stone-400);font-size:0.82rem">QR generation failed</p>';
  }
}

function closeQR() {
  document.getElementById('qr-modal').classList.remove('open');
}
document.getElementById('qr-modal').addEventListener('click', function(e) {
  if (e.target === this) closeQR();
});

async function exportVcf() {
  try {
    const res = await api('/export/vcf');
    if (!res.ok) { showToast('Export failed'); return; }
    const text = await res.text();
    const blob = new Blob([text], { type: 'text/vcard' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'rolodex-contacts.vcf';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Exported contacts as .vcf');
  } catch { showToast('Export failed'); }
}

async function exportCsv() {
  try {
    const res = await api('/export/csv');
    if (!res.ok) { showToast('Export failed'); return; }
    const text = await res.text();
    const blob = new Blob([text], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'rolodex-contacts.csv';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Exported contacts as .csv');
  } catch { showToast('Export failed'); }
}

async function togglePrivacy() {
  try {
    const res = await api('/settings', {
      method: 'PATCH',
      body: { isPublic: !ME.isPublic },
    });
    if (res.ok) {
      ME.isPublic = !ME.isPublic;
      const desc = document.getElementById('privacy-desc');
      if (desc) desc.textContent = ME.isPublic
        ? 'Public â€” anyone can see your friend list'
        : 'Private â€” only friends see your friend list';
      showToast(ME.isPublic ? 'Profile set to public' : 'Profile set to private');
    }
  } catch { showToast('Failed to update'); }
}

function editProfile() {
  const name = prompt('Display name:', ME.displayName);
  if (name === null) return;
  const bio = prompt('Bio:', ME.bio || '');
  if (bio === null) return;

  api('/users/me', {
    method: 'PATCH',
    body: { displayName: name.trim() || ME.displayName, bio: bio.trim() },
  }).then(async res => {
    if (res.ok) {
      await loadMe();
      renderApp('settings');
      showToast('Profile updated!');
    } else { showToast('Update failed'); }
  }).catch(() => showToast('Update failed'));
}

async function loadNotificationsView() {
  currentView = 'settings';
  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="view">
      <div class="top-bar">
        <div class="top-bar-row">
          <button class="back-btn" onclick="renderApp('settings')">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4L5 9l6 5"/></svg>
            Back
          </button>
          <button class="btn btn-sm btn-secondary" onclick="markAllRead()">Mark all read</button>
        </div>
        <h1 style="margin-top:8px">Notifications</h1>
      </div>
      <div id="notif-list"><div class="loading-center"><div class="spinner"></div></div></div>
    </div>
    <nav class="bottom-nav">
      <button class="nav-btn" onclick="viewStack=[];renderApp('my-profile')"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="8" r="4"/><path d="M3 20c0-4.4 3.6-8 8-8s8 3.6 8 8"/></svg>Me</button>
      <button class="nav-btn" onclick="viewStack=[];friendsCache=null;renderApp('friends')"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="8" cy="7" r="3.5"/><circle cx="16" cy="9" r="2.5"/><path d="M1 19c0-3.9 3.1-7 7-7 1.6 0 3 .5 4.2 1.4M13 19c0-2.8 1.8-5 4-5s4 2.2 4 5"/></svg>Friends</button>
      <button class="nav-btn" onclick="viewStack=[];renderApp('discover')"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="7.5"/><path d="M16 16l4 4"/><circle cx="11" cy="9" r="2.5"/><path d="M7 15c0-2.2 1.8-4 4-4s4 1.8 4 4"/></svg>Discover</button>
      <button class="nav-btn active" onclick="viewStack=[];renderApp('settings')"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="3"/><path d="M11 2v3M11 17v3M2 11h3M17 11h3M4.9 4.9l2.1 2.1M15 15l2.1 2.1M4.9 17.1l2.1-2.1M15 7l2.1-2.1"/></svg>Settings</button>
    </nav>
  `;

  try {
    const res = await api('/users/me/notifications?limit=50');
    if (!res.ok) return;
    const data = await res.json();
    const list = document.getElementById('notif-list');
    if (!list) return;

    if (!data.notifications || data.notifications.length === 0) {
      list.innerHTML = '<div class="empty-state"><p>No notifications yet</p></div>';
      return;
    }

    list.innerHTML = data.notifications.map(n => `
      <div class="person-row" style="${n.read ? 'opacity:0.6' : ''}" onclick="markNotifRead('${n.id}', this)">
        <div class="settings-icon ${n.type === 'friend_request' ? 'blue' : 'teal'}" style="width:40px;height:40px;border-radius:50%">
          ${n.type === 'friend_request' ? 'ğŸ‘‹' : 'âœ“'}
        </div>
        <div class="person-info">
          <div class="person-name" style="font-size:0.88rem">${escHtml(n.message)}</div>
          <div class="person-handle">${new Date(n.createdAt).toLocaleDateString()}</div>
        </div>
        ${n.read ? '' : '<div style="width:8px;height:8px;border-radius:50%;background:var(--teal-500);flex-shrink:0"></div>'}
      </div>
    `).join('');
  } catch {}
}

async function markNotifRead(id, el) {
  try {
    await api(`/users/me/notifications/${id}/read`, { method: 'POST' });
    if (el) el.style.opacity = '0.6';
    unreadNotifCount = Math.max(0, unreadNotifCount - 1);
  } catch {}
}

async function markAllRead() {
  try {
    await api('/users/me/notifications/read-all', { method: 'POST' });
    unreadNotifCount = 0;
    showToast('All notifications marked as read');
    loadNotificationsView();
  } catch {}
}

function doSignOut() {
  clearTokens();
  ME = null;
  friendsCache = null;
  renderApp('auth');
  showToast('Signed out');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init() {
  const tokens = getTokens();
  if (tokens) {
    const me = await loadMe();
    if (me) {
      renderApp('my-profile');
      return;
    }
  }
  renderApp('auth');
})();
</script>

</body>
</html>
